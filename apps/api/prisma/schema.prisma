generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── System / Platform ────────────────────────────────────────────────────

model Tenant {
  id        String   @id @default(uuid())
  name      String
  status    String   @default("trial") // active | suspended | trial
  isSuperAdmin Boolean @default(false)  // system tenant for super-admins
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domains       TenantDomain[]
  config        TenantConfig?
  users         User[]
  featureFlags  TenantFeature[]
  auditEvents   AuditEvent[]
  catalogTests  CatalogTest[]
  catalogPanels CatalogPanel[]
  roles         Role[]
  encounters    Encounter[]
  patients      Patient[]
  labOrders     LabOrder[]
  specimens     Specimen[]
  specimenItems SpecimenItem[]
  labResults    LabResult[]
  parameters           Parameter[]
  testParameterMappings TestParameterMapping[]
  panelTestMappings    PanelTestMapping[]
  referenceRanges      ReferenceRange[]
  jobRuns              JobRun[]
  documentTemplates    DocumentTemplate[]
  documents            Document[]
  cashTransactions     CashTransaction[]
  providers            Provider[]
  providerSchedules    ProviderSchedule[]
  appointments         Appointment[]
  opdVisits            OPDVisit[]
  opdVitals            OPDVitals[]
  opdClinicalNotes     OPDClinicalNote[]
  opdPrescriptions     OPDPrescription[]
  opdPrescriptionItems OPDPrescriptionItem[]
  invoices             Invoice[]
  invoiceLines         InvoiceLine[]
  payments             Payment[]

  @@map("tenants")
}

model TenantDomain {
  id       String @id @default(uuid())
  tenantId String
  domain   String @unique  // globally unique — one domain maps to one tenant

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([domain])
  @@map("tenant_domains")
}

model TenantConfig {
  id                 String  @id @default(uuid())
  tenantId           String  @unique
  brandName          String?
  logoUrl            String?
  primaryColor       String?
  reportHeader       String?
  reportFooter       String?
  headerText         String?
  footerText         String?
  registrationPrefix String? // e.g. "VX" — 2-3 letters; server appends -YY-SEQ
  orderPrefix        String? // e.g. "VX" — server appends module letter + YYMM + SEQ
  updatedAt          DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("tenant_configs")
}

model User {
  id               String   @id @default(uuid())
  tenantId         String
  email            String
  firstName        String
  lastName         String
  passwordHash     String
  status           String   @default("active") // active | disabled | pending
  isSuperAdmin     Boolean  @default(false)    // super-admin bypasses all RBAC
  maxDiscountPct   Decimal? @db.Decimal(5,2)   // overrides role default when set
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  userRoles        UserRole[]
  refreshTokens    RefreshToken[]
  auditEvents      AuditEvent[]
  cashTransactions CashTransaction[]

  @@unique([tenantId, email])
  @@index([tenantId, status])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique  // hashed token stored
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Role {
  id                String   @id @default(uuid())
  tenantId          String
  name              String
  description       String?
  isSystem          Boolean  @default(false)  // system roles cannot be deleted
  maxDiscountPct    Decimal? @db.Decimal(5,2) // max % discount this role may apply
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

// System-defined permission keys
// Stored as strings so schema doesn't need to change when adding new permissions
model RolePermission {
  roleId     String
  permission String  // matches Permission enum values

  role Role @relation(fields: [roleId], references: [id])

  @@id([roleId, permission])
  @@map("role_permissions")
}

model UserRole {
  userId    String
  roleId    String
  grantedBy String?  // userId who granted this role
  grantedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model TenantFeature {
  id          String   @id @default(uuid())
  tenantId    String
  key         String   // e.g. module.lims, module.printing
  enabled     Boolean  @default(false)
  variantJson String?  // JSON string for variant-type flags e.g. {"mode":"separate"}
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // userId who last changed it

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("tenant_features")
}

// ─── Catalog ──────────────────────────────────────────────────────────────

model CatalogTest {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  sampleType      String?  // legacy field kept for compat
  specimenType    String?  // exact specimen type e.g. "EDTA Blood", "Clot Blood", "Urine"
  price           Decimal? @db.Decimal(10,2) // price in PKR
  turnaroundHours Int?
  isActive        Boolean  @default(true)
  externalId      String?
  userCode        String?
  loincCode       String?
  department      String?
  method          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  labOrders LabOrder[]
  parameterMappings TestParameterMapping[]
  panelMappings     PanelTestMapping[]

  @@unique([tenantId, externalId], name: "tenant_test_externalId")
  @@index([tenantId, isActive])
  @@map("catalog_tests")
}

model CatalogPanel {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  price       Decimal? @db.Decimal(10,2) // price in PKR
  isActive    Boolean  @default(true)
  externalId  String?
  userCode    String?
  loincCode   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  testMappings PanelTestMapping[]

  @@unique([tenantId, externalId], name: "tenant_panel_externalId")
  @@map("catalog_panels")
}

model Parameter {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  unit          String?
  ucumCode      String?  // UCUM unit code (e.g. "mg/dL", "mmol/L")
  dataType      String   @default("numeric")
  isActive      Boolean  @default(true)
  externalId    String?
  userCode      String?
  loincCode     String?
  resultType    String   @default("numeric")
  defaultUnit   String?
  decimals      Int?
  allowedValues String?
  defaultValue  String?  // pre-filled value shown in result entry
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant          Tenant                 @relation(fields: [tenantId], references: [id])
  testMappings    TestParameterMapping[]
  referenceRanges ReferenceRange[]

  @@unique([tenantId, externalId], name: "tenant_param_externalId")
  @@index([tenantId, isActive])
  @@map("parameters")
}

model TestParameterMapping {
  id           String  @id @default(uuid())
  tenantId     String
  testId       String
  parameterId  String
  ordering     Int     @default(0)
  displayOrder Int     @default(0)
  isRequired   Boolean @default(true)
  unitOverride String?

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  test      CatalogTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  parameter Parameter   @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  @@unique([tenantId, testId, parameterId])
  @@index([tenantId, testId])
  @@map("test_parameter_mappings")
}

model PanelTestMapping {
  id           String @id @default(uuid())
  tenantId     String
  panelId      String
  testId       String
  ordering     Int    @default(0)
  displayOrder Int    @default(0)

  tenant Tenant       @relation(fields: [tenantId], references: [id])
  panel  CatalogPanel @relation(fields: [panelId], references: [id], onDelete: Cascade)
  test   CatalogTest  @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([tenantId, panelId, testId])
  @@index([tenantId, panelId])
  @@map("panel_test_mappings")
}

model ReferenceRange {
  id           String   @id @default(uuid())
  tenantId     String
  parameterId  String
  testId       String?
  gender       String?
  ageMinYears  Int?
  ageMaxYears  Int?
  lowValue     Float?
  highValue    Float?
  criticalLow  Float?
  criticalHigh Float?
  unit         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  parameter Parameter @relation(fields: [parameterId], references: [id])

  @@index([tenantId, parameterId])
  @@map("reference_ranges")
}

model JobRun {
  id            String    @id @default(uuid())
  tenantId      String
  type          String
  status        String    @default("queued")
  payloadHash   String?
  correlationId String
  startedAt     DateTime?
  finishedAt    DateTime?
  resultSummary Json?
  errorSummary  String?
  createdBy     String
  createdAt     DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, type, payloadHash])
  @@index([tenantId, type, status])
  @@index([tenantId, createdAt])
  @@map("job_runs")
}

// ─── Audit (append-only — no updates, no deletes) ─────────────────────────

model AuditEvent {
  id            String   @id @default(uuid())
  tenantId      String
  actorUserId   String?
  action        String   // e.g. user.create, role.assign, feature_flag.set
  entityType    String?
  entityId      String?
  correlationId String?
  before        Json?
  after         Json?
  metadata      Json?    // extra context (e.g. IP, user-agent)
  createdAt     DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  actor  User?  @relation(fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, actorUserId])
  @@index([tenantId, entityType, entityId])
  @@index([correlationId])
  @@map("audit_events")
}

// ─── LIMS ──────────────────────────────────────────────────────────────────

model Patient {
  id               String    @id @default(uuid())
  tenantId         String
  firstName        String
  lastName         String
  dateOfBirth      DateTime?
  ageYears         Int?      // alternate to DOB; stored if DOB not known
  gender           String?
  mrn              String    // Registration Number — server-generated, permanent
  mobile           String?
  cnic             String?   // National ID (optional)
  address          String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  encounters   Encounter[]
  appointments Appointment[]
  opdVisits    OPDVisit[]
  invoices     Invoice[]

  @@unique([tenantId, mrn])
  @@index([tenantId, lastName])
  @@index([tenantId, mobile])
  @@map("patients")
}

model Encounter {
  id            String   @id @default(uuid())
  tenantId      String
  patientId     String
  moduleType    String   @default("LIMS") // LIMS | OPD
  encounterCode String?  // LIMS Order ID — server-generated e.g. VXL-2602-001
  status        String   @default("registered")
  // registered | lab_ordered | specimen_collected | specimen_received
  // | partial_resulted | resulted | verified | cancelled
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  patient          Patient          @relation(fields: [patientId], references: [id])
  labOrders        LabOrder[]
  specimenItems    SpecimenItem[]
  cashTransactions CashTransaction[]
  opdVisits        OPDVisit[]
  invoices         Invoice[]

  @@unique([tenantId, encounterCode])
  @@index([tenantId, status])
  @@index([tenantId, moduleType, status])
  @@index([tenantId, patientId])
  @@map("encounters")
}

model LabOrder {
  id               String    @id @default(uuid())
  tenantId         String
  encounterId      String
  testId           String
  testNameSnapshot String?   // snapshot at order time
  status           String    @default("ordered") // ordered | specimen_collected | processing | resulted | verified | cancelled
  resultStatus     String    @default("PENDING") // PENDING | SUBMITTED
  priority         String    @default("routine") // routine | stat | urgent
  // Financials (captured at order time)
  totalAmount      Decimal?  @db.Decimal(10,2)
  discountAmount   Decimal?  @db.Decimal(10,2)
  discountPct      Decimal?  @db.Decimal(5,2)
  payableAmount    Decimal?  @db.Decimal(10,2)
  amountPaid       Decimal?  @db.Decimal(10,2)
  dueAmount        Decimal?  @db.Decimal(10,2)
  submittedAt      DateTime?
  submittedById    String?
  cancelledAt      DateTime?
  cancelReason     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  encounter        Encounter        @relation(fields: [encounterId], references: [id])
  test             CatalogTest      @relation(fields: [testId], references: [id])
  specimen         Specimen?
  results          LabResult[]
  cashTransactions CashTransaction[]

  @@index([tenantId, status])
  @@index([tenantId, resultStatus])
  @@index([tenantId, encounterId])
  @@map("lab_orders")
}

model Specimen {
  id          String    @id @default(uuid())
  tenantId    String
  labOrderId  String    @unique
  barcode     String
  type        String
  collectedAt DateTime?
  receivedAt  DateTime?
  status      String    @default("pending") // pending | collected | received | rejected
  createdAt   DateTime  @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  labOrder LabOrder @relation(fields: [labOrderId], references: [id])

  @@unique([tenantId, barcode])
  @@index([tenantId, barcode])
  @@map("specimens")
}

// One SpecimenItem per unique catalogSpecimenType per encounter
// Auto-created when lab order is placed; groups tests by specimen type
model SpecimenItem {
  id                  String    @id @default(uuid())
  tenantId            String
  encounterId         String
  catalogSpecimenType String    // exact value from CatalogTest.specimenType e.g. "EDTA Blood"
  status              String    @default("PENDING") // PENDING | COLLECTED | POSTPONED | RECEIVED
  barcode             String?   // system-generated if barcode feature flag enabled
  collectedAt         DateTime?
  collectedById       String?
  postponedAt         DateTime?
  postponedById       String?
  postponeReason      String?
  receivedAt          DateTime?
  receivedById        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  encounter Encounter @relation(fields: [encounterId], references: [id])

  @@unique([tenantId, encounterId, catalogSpecimenType])
  @@index([tenantId, status])
  @@index([tenantId, encounterId])
  @@map("specimen_items")
}

model LabResult {
  id                   String    @id @default(uuid())
  tenantId             String
  labOrderId           String
  parameterId          String?   // null for legacy single-value results
  parameterNameSnapshot String?  // snapshot at entry time
  value                String
  unit                 String?
  ucumCode             String?
  referenceRange       String?
  flag                 String?   // normal | high | low | critical
  locked               Boolean   @default(false) // true once test is submitted
  enteredAt            DateTime  @default(now())
  enteredById          String?
  verifiedAt           DateTime?
  verifiedBy           String?

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  labOrder LabOrder @relation(fields: [labOrderId], references: [id])

  @@index([tenantId])
  @@index([tenantId, labOrderId])
  @@map("lab_results")
}

// ─── OPD / Billing (MVP scaffold; contract-first endpoints come later) ──────

model Provider {
  id             String   @id @default(uuid())
  tenantId       String
  code           String?
  displayName    String
  specialty      String?
  registrationNo String?
  qualification  String?
  phone          String?
  email          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  schedules     ProviderSchedule[]
  appointments  Appointment[]
  opdVisits     OPDVisit[]
  clinicalNotes OPDClinicalNote[]
  prescriptions OPDPrescription[]

  @@unique([tenantId, code], name: "tenant_provider_code")
  @@unique([tenantId, registrationNo], name: "tenant_provider_registrationNo")
  @@index([tenantId, isActive])
  @@index([tenantId, displayName])
  @@map("providers")
}

model ProviderSchedule {
  id            String   @id @default(uuid())
  tenantId      String
  providerId    String
  weekday       Int      // 0-6; interpretation locked at API layer
  startTime     String   // HH:mm
  endTime       String   // HH:mm
  slotMinutes   Int      @default(15)
  isActive      Boolean  @default(true)
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  provider  Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([tenantId, providerId, weekday, startTime, endTime])
  @@index([tenantId, providerId, weekday, isActive])
  @@map("provider_schedules")
}

model Appointment {
  id                    String   @id @default(uuid())
  tenantId              String
  patientId             String
  providerId            String
  appointmentCode       String?
  status                String   @default("BOOKED") // BOOKED | CHECKED_IN | IN_CONSULTATION | COMPLETED | CANCELLED | NO_SHOW
  scheduledAt           DateTime
  durationMinutes       Int      @default(15)
  reason                String?
  notes                 String?
  checkedInAt           DateTime?
  consultationStartedAt DateTime?
  completedAt           DateTime?
  cancelledAt           DateTime?
  cancelledReason       String?
  noShowMarkedAt        DateTime?
  bookedById            String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  patient  Patient   @relation(fields: [patientId], references: [id])
  provider Provider  @relation(fields: [providerId], references: [id])
  opdVisits OPDVisit[]

  @@unique([tenantId, appointmentCode])
  @@index([tenantId, status, scheduledAt])
  @@index([tenantId, patientId, scheduledAt])
  @@index([tenantId, providerId, scheduledAt])
  @@map("appointments")
}

model OPDVisit {
  id                    String   @id @default(uuid())
  tenantId              String
  encounterId           String
  patientId             String
  providerId            String
  appointmentId         String?
  visitCode             String?
  status                String   @default("REGISTERED") // REGISTERED | WAITING | IN_CONSULTATION | COMPLETED | CANCELLED
  chiefComplaint        String?
  queueNumber           String?
  waitingAt             DateTime?
  consultationStartedAt DateTime?
  completedAt           DateTime?
  cancelledAt           DateTime?
  cancelledReason       String?
  createdById           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  encounter     Encounter          @relation(fields: [encounterId], references: [id])
  patient       Patient            @relation(fields: [patientId], references: [id])
  provider      Provider           @relation(fields: [providerId], references: [id])
  appointment   Appointment?       @relation(fields: [appointmentId], references: [id])
  vitals        OPDVitals[]
  clinicalNotes OPDClinicalNote[]
  prescriptions OPDPrescription[]
  invoices      Invoice[]

  @@unique([tenantId, encounterId])
  @@unique([tenantId, appointmentId])
  @@unique([tenantId, visitCode])
  @@index([tenantId, status, createdAt])
  @@index([tenantId, patientId, createdAt])
  @@index([tenantId, providerId, createdAt])
  @@index([tenantId, appointmentId])
  @@map("opd_visits")
}

model OPDVitals {
  id               String   @id @default(uuid())
  tenantId         String
  visitId          String
  recordedAt       DateTime @default(now())
  recordedById     String?
  heightCm         Decimal? @db.Decimal(5,2)
  weightKg         Decimal? @db.Decimal(5,2)
  bmi              Decimal? @db.Decimal(5,2)
  temperatureC     Decimal? @db.Decimal(4,1)
  pulseBpm         Int?
  systolicBp       Int?
  diastolicBp      Int?
  respiratoryRate  Int?
  spo2Pct          Int?
  bloodGlucoseMgDl Decimal? @db.Decimal(6,2)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  visit  OPDVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([tenantId, visitId, recordedAt])
  @@map("opd_vitals")
}

model OPDClinicalNote {
  id             String   @id @default(uuid())
  tenantId       String
  visitId        String
  providerId     String
  status         String   @default("DRAFT") // DRAFT | SIGNED
  subjectiveJson Json?
  objectiveJson  Json?
  assessmentJson Json?
  planJson       Json?
  diagnosisText  String?
  signedAt       DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  visit    OPDVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id])

  @@unique([tenantId, visitId])
  @@index([tenantId, providerId, createdAt])
  @@index([tenantId, status])
  @@map("opd_clinical_notes")
}

model OPDPrescription {
  id         String   @id @default(uuid())
  tenantId   String
  visitId    String
  providerId String
  status     String   @default("DRAFT") // DRAFT | SIGNED | PRINTED
  notes      String?
  signedAt   DateTime?
  printedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant   Tenant                @relation(fields: [tenantId], references: [id])
  visit    OPDVisit              @relation(fields: [visitId], references: [id], onDelete: Cascade)
  provider Provider              @relation(fields: [providerId], references: [id])
  items    OPDPrescriptionItem[]

  @@unique([tenantId, visitId])
  @@index([tenantId, providerId, createdAt])
  @@index([tenantId, status])
  @@map("opd_prescriptions")
}

model OPDPrescriptionItem {
  id             String   @id @default(uuid())
  tenantId       String
  prescriptionId String
  sortOrder      Int      @default(0)
  medicationText String
  dosageText     String?
  frequencyText  String?
  durationText   String?
  instructions   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id])
  prescription OPDPrescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, prescriptionId, sortOrder])
  @@index([tenantId, prescriptionId])
  @@map("opd_prescription_items")
}

model Invoice {
  id             String   @id @default(uuid())
  tenantId       String
  patientId      String
  encounterId    String?
  opdVisitId     String?
  invoiceCode    String?
  status         String   @default("DRAFT") // DRAFT | ISSUED | PARTIALLY_PAID | PAID | VOID
  currency       String   @default("PKR")
  subtotalAmount Decimal  @db.Decimal(10,2)
  discountAmount Decimal  @default(0) @db.Decimal(10,2)
  totalAmount    Decimal  @db.Decimal(10,2)
  amountPaid     Decimal  @default(0) @db.Decimal(10,2)
  amountDue      Decimal  @db.Decimal(10,2)
  issuedAt       DateTime?
  voidedAt       DateTime?
  voidReason     String?
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  patient   Patient    @relation(fields: [patientId], references: [id])
  encounter Encounter? @relation(fields: [encounterId], references: [id])
  opdVisit  OPDVisit?  @relation(fields: [opdVisitId], references: [id])
  lines     InvoiceLine[]
  payments  Payment[]

  @@unique([tenantId, invoiceCode])
  @@index([tenantId, status, createdAt])
  @@index([tenantId, patientId, createdAt])
  @@index([tenantId, opdVisitId])
  @@index([tenantId, encounterId])
  @@map("invoices")
}

model InvoiceLine {
  id             String   @id @default(uuid())
  tenantId       String
  invoiceId      String
  sortOrder      Int      @default(0)
  lineType       String   @default("SERVICE") // SERVICE | ADJUSTMENT
  description    String
  quantity       Decimal  @default(1) @db.Decimal(10,2)
  unitPrice      Decimal  @db.Decimal(10,2)
  discountAmount Decimal  @default(0) @db.Decimal(10,2)
  lineTotal      Decimal  @db.Decimal(10,2)
  metadataJson   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, invoiceId, sortOrder])
  @@index([tenantId, invoiceId])
  @@map("invoice_lines")
}

model Payment {
  id            String   @id @default(uuid())
  tenantId      String
  invoiceId     String
  paymentCode   String?
  status        String   @default("POSTED") // POSTED | VOIDED
  method        String   @default("CASH") // CASH | CARD | TRANSFER (future expansion)
  amount        Decimal  @db.Decimal(10,2)
  receivedAt    DateTime @default(now())
  receivedById  String?
  referenceNo   String?
  note          String?
  correlationId String?
  voidedAt      DateTime?
  voidReason    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, paymentCode])
  @@index([tenantId, invoiceId, receivedAt])
  @@index([tenantId, status])
  @@index([tenantId, correlationId])
  @@map("payments")
}

// ─── Documents ────────────────────────────────────────────────────────────

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  type        String   // RECEIPT | LAB_REPORT
  templateKey String   // e.g. "receipt_v1", "lab_report_v1"
  version     Int      @default(1)
  config      Json?    // template-level config overrides
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  documents Document[]

  @@unique([tenantId, type, version])
  @@index([tenantId, type, isActive])
  @@map("document_templates")
}

model Document {
  id           String    @id @default(uuid())
  tenantId     String
  type         String    // RECEIPT | LAB_REPORT
  templateId   String
  payloadJson  Json
  payloadHash  String    // sha256(canonical_json)
  pdfHash      String?   // sha256(pdf_bytes); null until rendered
  storageKey   String?   // MinIO object key e.g. {tenantId}/{documentId}/report.pdf
  status       String    @default("DRAFT") // DRAFT | RENDERING | RENDERED | PUBLISHED | FAILED
  version      Int       @default(1)
  sourceRef    String?   // e.g. encounterId, orderId
  sourceType   String?   // ENCOUNTER | ORDER
  errorMessage String?
  publishedAt  DateTime?
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [id])
  template DocumentTemplate @relation(fields: [templateId], references: [id])

  @@unique([tenantId, type, payloadHash])
  @@index([tenantId, status])
  @@index([tenantId, sourceRef, sourceType])
  @@index([tenantId, createdAt])
  @@map("documents")
}

// Cash transaction log — immutable append-only ledger
model CashTransaction {
  id          String   @id @default(uuid())
  tenantId    String
  encounterId String
  labOrderId  String?
  type        String   // PAYMENT | DISCOUNT | REFUND | DUE_RECEIVED | CANCELLATION_REFUND
  amount      Decimal  @db.Decimal(10,2) // always positive; type gives direction
  actorUserId String
  reason      String?  // required for DISCOUNT, CANCELLATION_REFUND
  correlationId String?
  createdAt   DateTime @default(now())

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  encounter Encounter @relation(fields: [encounterId], references: [id])
  labOrder  LabOrder? @relation(fields: [labOrderId], references: [id])
  actor     User      @relation(fields: [actorUserId], references: [id])

  @@index([tenantId, encounterId])
  @@index([tenantId, actorUserId])
  @@index([tenantId, type])
  @@index([tenantId, createdAt])
  @@map("cash_transactions")
}
