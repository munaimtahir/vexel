generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── System / Platform ────────────────────────────────────────────────────

model Tenant {
  id        String   @id @default(uuid())
  name      String
  status    String   @default("trial") // active | suspended | trial
  isSuperAdmin Boolean @default(false)  // system tenant for super-admins
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domains       TenantDomain[]
  config        TenantConfig?
  users         User[]
  featureFlags  TenantFeature[]
  auditEvents   AuditEvent[]
  catalogTests  CatalogTest[]
  catalogPanels CatalogPanel[]
  roles         Role[]
  encounters    Encounter[]
  patients      Patient[]
  labOrders     LabOrder[]
  specimens     Specimen[]
  labResults    LabResult[]
  parameters           Parameter[]
  testParameterMappings TestParameterMapping[]
  panelTestMappings    PanelTestMapping[]
  referenceRanges      ReferenceRange[]
  jobRuns              JobRun[]
  documentTemplates    DocumentTemplate[]
  documents            Document[]

  @@map("tenants")
}

model TenantDomain {
  id       String @id @default(uuid())
  tenantId String
  domain   String @unique  // globally unique — one domain maps to one tenant

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([domain])
  @@map("tenant_domains")
}

model TenantConfig {
  id           String  @id @default(uuid())
  tenantId     String  @unique
  brandName    String?
  logoUrl      String?
  primaryColor String?
  reportHeader String?
  reportFooter String?
  headerText   String?
  footerText   String?
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("tenant_configs")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String
  firstName    String
  lastName     String
  passwordHash String
  status       String   @default("active") // active | disabled | pending
  isSuperAdmin Boolean  @default(false)    // super-admin bypasses all RBAC
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  userRoles     UserRole[]
  refreshTokens RefreshToken[]
  auditEvents   AuditEvent[]

  @@unique([tenantId, email])
  @@index([tenantId, status])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique  // hashed token stored
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isSystem    Boolean  @default(false)  // system roles cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

// System-defined permission keys
// Stored as strings so schema doesn't need to change when adding new permissions
model RolePermission {
  roleId     String
  permission String  // matches Permission enum values

  role Role @relation(fields: [roleId], references: [id])

  @@id([roleId, permission])
  @@map("role_permissions")
}

model UserRole {
  userId    String
  roleId    String
  grantedBy String?  // userId who granted this role
  grantedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model TenantFeature {
  id          String   @id @default(uuid())
  tenantId    String
  key         String   // e.g. module.lims, module.printing
  enabled     Boolean  @default(false)
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // userId who last changed it

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("tenant_features")
}

// ─── Catalog ──────────────────────────────────────────────────────────────

model CatalogTest {
  id              String   @id @default(uuid())
  tenantId        String
  code            String
  name            String
  description     String?
  sampleType      String?
  turnaroundHours Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  labOrders LabOrder[]
  parameterMappings TestParameterMapping[]
  panelMappings     PanelTestMapping[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@map("catalog_tests")
}

model CatalogPanel {
  id          String   @id @default(uuid())
  tenantId    String
  code        String
  name        String
  description String?
  testIds     String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  testMappings PanelTestMapping[]

  @@unique([tenantId, code])
  @@map("catalog_panels")
}

model Parameter {
  id          String   @id @default(uuid())
  tenantId    String
  code        String
  name        String
  unit        String?
  dataType    String   @default("numeric")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant                 @relation(fields: [tenantId], references: [id])
  testMappings    TestParameterMapping[]
  referenceRanges ReferenceRange[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@map("parameters")
}

model TestParameterMapping {
  id          String @id @default(uuid())
  tenantId    String
  testId      String
  parameterId String
  ordering    Int    @default(0)

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  test      CatalogTest @relation(fields: [testId], references: [id])
  parameter Parameter   @relation(fields: [parameterId], references: [id])

  @@unique([tenantId, testId, parameterId])
  @@index([tenantId, testId])
  @@map("test_parameter_mappings")
}

model PanelTestMapping {
  id       String @id @default(uuid())
  tenantId String
  panelId  String
  testId   String
  ordering Int    @default(0)

  tenant Tenant       @relation(fields: [tenantId], references: [id])
  panel  CatalogPanel @relation(fields: [panelId], references: [id])
  test   CatalogTest  @relation(fields: [testId], references: [id])

  @@unique([tenantId, panelId, testId])
  @@index([tenantId, panelId])
  @@map("panel_test_mappings")
}

model ReferenceRange {
  id           String   @id @default(uuid())
  tenantId     String
  parameterId  String
  testId       String?
  gender       String?
  ageMinYears  Int?
  ageMaxYears  Int?
  lowValue     Float?
  highValue    Float?
  criticalLow  Float?
  criticalHigh Float?
  unit         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  parameter Parameter @relation(fields: [parameterId], references: [id])

  @@index([tenantId, parameterId])
  @@map("reference_ranges")
}

model JobRun {
  id            String    @id @default(uuid())
  tenantId      String
  type          String
  status        String    @default("queued")
  payloadHash   String?
  correlationId String
  startedAt     DateTime?
  finishedAt    DateTime?
  resultSummary Json?
  errorSummary  String?
  createdBy     String
  createdAt     DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, type, payloadHash])
  @@index([tenantId, type, status])
  @@index([tenantId, createdAt])
  @@map("job_runs")
}

// ─── Audit (append-only — no updates, no deletes) ─────────────────────────

model AuditEvent {
  id            String   @id @default(uuid())
  tenantId      String
  actorUserId   String?
  action        String   // e.g. user.create, role.assign, feature_flag.set
  entityType    String?
  entityId      String?
  correlationId String?
  before        Json?
  after         Json?
  metadata      Json?    // extra context (e.g. IP, user-agent)
  createdAt     DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  actor  User?  @relation(fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, actorUserId])
  @@index([tenantId, entityType, entityId])
  @@index([correlationId])
  @@map("audit_events")
}

// ─── LIMS ──────────────────────────────────────────────────────────────────

model Patient {
  id          String    @id @default(uuid())
  tenantId    String
  firstName   String
  lastName    String
  dateOfBirth DateTime?
  gender      String?
  mrn         String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  encounters Encounter[]

  @@unique([tenantId, mrn])
  @@index([tenantId, lastName])
  @@map("patients")
}

model Encounter {
  id        String   @id @default(uuid())
  tenantId  String
  patientId String
  status    String   @default("registered") // registered | lab_ordered | specimen_collected | resulted | verified | cancelled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  patient   Patient    @relation(fields: [patientId], references: [id])
  labOrders LabOrder[]

  @@index([tenantId, status])
  @@index([tenantId, patientId])
  @@map("encounters")
}

model LabOrder {
  id          String   @id @default(uuid())
  tenantId    String
  encounterId String
  testId      String
  status      String   @default("ordered") // ordered | specimen_collected | processing | resulted | verified | cancelled
  priority    String   @default("routine") // routine | stat | urgent
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  encounter Encounter   @relation(fields: [encounterId], references: [id])
  test      CatalogTest @relation(fields: [testId], references: [id])
  specimen  Specimen?
  result    LabResult?

  @@index([tenantId, status])
  @@index([tenantId, encounterId])
  @@map("lab_orders")
}

model Specimen {
  id         String    @id @default(uuid())
  tenantId   String
  labOrderId String    @unique
  barcode    String
  type       String
  collectedAt DateTime?
  status     String    @default("pending") // pending | collected | received | rejected
  createdAt  DateTime  @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  labOrder LabOrder @relation(fields: [labOrderId], references: [id])

  @@unique([tenantId, barcode])
  @@index([tenantId, barcode])
  @@map("specimens")
}

model LabResult {
  id             String    @id @default(uuid())
  tenantId       String
  labOrderId     String    @unique
  value          String
  unit           String?
  referenceRange String?
  flag           String?   // normal | high | low | critical
  resultedAt     DateTime  @default(now())
  resultedBy     String?
  verifiedAt     DateTime?
  verifiedBy     String?

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  labOrder LabOrder @relation(fields: [labOrderId], references: [id])

  @@index([tenantId])
  @@map("lab_results")
}

// ─── Documents ────────────────────────────────────────────────────────────

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  type        String   // RECEIPT | LAB_REPORT
  templateKey String   // e.g. "receipt_v1", "lab_report_v1"
  version     Int      @default(1)
  config      Json?    // template-level config overrides
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  documents Document[]

  @@unique([tenantId, type, version])
  @@index([tenantId, type, isActive])
  @@map("document_templates")
}

model Document {
  id           String    @id @default(uuid())
  tenantId     String
  type         String    // RECEIPT | LAB_REPORT
  templateId   String
  payloadJson  Json
  payloadHash  String    // sha256(canonical_json)
  pdfHash      String?   // sha256(pdf_bytes); null until rendered
  storageKey   String?   // MinIO object key e.g. {tenantId}/{documentId}/report.pdf
  status       String    @default("DRAFT") // DRAFT | RENDERING | RENDERED | PUBLISHED | FAILED
  version      Int       @default(1)
  sourceRef    String?   // e.g. encounterId, orderId
  sourceType   String?   // ENCOUNTER | ORDER
  errorMessage String?
  publishedAt  DateTime?
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [id])
  template DocumentTemplate @relation(fields: [templateId], references: [id])

  @@unique([tenantId, type, payloadHash])
  @@index([tenantId, status])
  @@index([tenantId, sourceRef, sourceType])
  @@index([tenantId, createdAt])
  @@map("documents")
}
