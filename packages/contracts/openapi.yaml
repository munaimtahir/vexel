openapi: 3.1.0
info:
  title: Vexel Health API (LIMS-first)
  version: 0.1.0
  description: |
    Contract-first OpenAPI spec for Vexel Health Platform.
    All admin endpoints require bearerAuth.
    All requests should include X-Correlation-ID header.
    Tenant is resolved server-side (Host header in prod, x-tenant-id in dev when enabled).

servers:
  - url: /api

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    CorrelationId:
      name: X-Correlation-ID
      in: header
      required: false
      schema:
        type: string
        format: uuid
      description: Client-supplied correlation ID. If not provided, server generates one.
    PageParam:
      name: page
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    LimitParam:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      required: [statusCode, message]
      properties:
        statusCode:
          type: integer
        message:
          type: string
        error:
          type: string
        correlationId:
          type: string

    Pagination:
      type: object
      required: [page, limit, total, totalPages]
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    HealthStatus:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok, degraded, down]
        version:
          type: string
        uptime:
          type: number
        services:
          type: object
          additionalProperties:
            type: string

    TokenResponse:
      type: object
      required: [accessToken, refreshToken, expiresIn]
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
        tokenType:
          type: string
          default: Bearer

    UserSummary:
      type: object
      required: [id, email, tenantId, status]
      properties:
        id:
          type: string
        email:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        tenantId:
          type: string
        roles:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, disabled, pending]
        isSuperAdmin:
          type: boolean
        createdAt:
          type: string
          format: date-time

    TenantSummary:
      type: object
      required: [id, name, status]
      properties:
        id:
          type: string
        name:
          type: string
        domains:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, suspended, trial]
        createdAt:
          type: string
          format: date-time

    TenantConfig:
      type: object
      properties:
        brandName:
          type: string
        logoUrl:
          type: string
        primaryColor:
          type: string
        headerText:
          type: string
        footerText:
          type: string
        reportHeader:
          type: string
          description: Header text printed on generated PDF reports
        reportFooter:
          type: string
          description: Footer text printed on generated PDF reports

    Role:
      type: object
      required: [id, name]
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        permissions:
          type: array
          description: List of permission keys assigned to this role
          items:
            type: string
        isSystem:
          type: boolean
          description: True for built-in system roles that cannot be deleted

    FeatureFlag:
      type: object
      required: [key, enabled]
      properties:
        key:
          type: string
        enabled:
          type: boolean
        description:
          type: string

    CatalogTest:
      type: object
      required: [id, tenantId, name]
      properties:
        id:
          type: string
        tenantId:
          type: string
        name:
          type: string
        description:
          type: string
        sampleType:
          type: string
        turnaroundHours:
          type: integer
        price:
          type: number
          minimum: 0
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        externalId:
          type: string
          nullable: true
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        department:
          type: string
          nullable: true
        specimenType:
          type: string
          nullable: true
        method:
          type: string
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true

    CatalogPanel:
      type: object
      required: [id, tenantId, name]
      properties:
        id:
          type: string
        tenantId:
          type: string
        name:
          type: string
        description:
          type: string
        price:
          type: number
          minimum: 0
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        externalId:
          type: string
          nullable: true
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true

    Parameter:
      type: object
      required: [id, tenantId, name, dataType, isActive]
      properties:
        id:
          type: string
        tenantId:
          type: string
        name:
          type: string
        unit:
          type: string
        dataType:
          type: string
          enum: [numeric, text, boolean, coded]
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        externalId:
          type: string
          description: Tenant-unique import identity key
          nullable: true
        userCode:
          type: string
          description: Tenant-specific daily-use local code
          nullable: true
        loincCode:
          type: string
          description: LOINC code for this parameter
          nullable: true
        resultType:
          type: string
          enum: [numeric, text, boolean, enum]
          description: Data type (renamed from dataType for clarity)
        defaultUnit:
          type: string
          description: UCUM unit string; required for numeric resultType
          nullable: true
        decimals:
          type: integer
          description: Decimal places for numeric results
          nullable: true
        allowedValues:
          type: array
          items:
            type: string
          description: Allowed values for enum resultType
          nullable: true
        defaultValue:
          type: string
          description: Default value for this parameter
          nullable: true

    TestParameterMapping:
      type: object
      required: [id, testId, parameterId]
      properties:
        id:
          type: string
        testId:
          type: string
        parameterId:
          type: string
        displayOrder:
          type: integer
          default: 0
        isRequired:
          type: boolean
          default: true
        unitOverride:
          type: string
          description: UCUM unit override for this test context
          nullable: true

    TestParameterMappingResponse:
      type: object
      required: [id, testId, parameterId]
      properties:
        id:
          type: string
        testId:
          type: string
        parameterId:
          type: string
        displayOrder:
          type: integer
          default: 0
        isRequired:
          type: boolean
          default: true
        unitOverride:
          type: string
          nullable: true

    PanelTestMapping:
      type: object
      required: [id, panelId, testId]
      properties:
        id:
          type: string
        panelId:
          type: string
        testId:
          type: string
        displayOrder:
          type: integer
          default: 0

    TestDefinition:
      type: object
      description: Complete ordered test definition for operator use
      required: [id, tenantId, name, parameters]
      properties:
        id:
          type: string
        tenantId:
          type: string
        code:
          type: string
        name:
          type: string
        externalId:
          type: string
          nullable: true
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        department:
          type: string
          nullable: true
        specimenType:
          type: string
          nullable: true
        method:
          type: string
          nullable: true
        price:
          type: number
          minimum: 0
          nullable: true
        isActive:
          type: boolean
        parameters:
          type: array
          description: Ordered parameters for this test
          items:
            $ref: '#/components/schemas/TestDefinitionParameter'

    TestDefinitionParameter:
      type: object
      required: [parameterId, name, displayOrder]
      properties:
        parameterId:
          type: string
        name:
          type: string
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        resultType:
          type: string
          enum: [numeric, text, boolean, enum]
        effectiveUnit:
          type: string
          description: unitOverride if set, else defaultUnit
          nullable: true
        decimals:
          type: integer
          nullable: true
        allowedValues:
          type: array
          items:
            type: string
          nullable: true
        defaultValue:
          type: string
          nullable: true
        displayOrder:
          type: integer
        isRequired:
          type: boolean

    PanelDefinition:
      type: object
      description: Complete ordered panel definition for operator use
      required: [id, tenantId, name, tests]
      properties:
        id:
          type: string
        tenantId:
          type: string
        code:
          type: string
        name:
          type: string
        externalId:
          type: string
          nullable: true
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        price:
          type: number
          minimum: 0
          nullable: true
        isActive:
          type: boolean
        tests:
          type: array
          description: Ordered tests in this panel
          items:
            $ref: '#/components/schemas/PanelDefinitionTest'

    PanelDefinitionTest:
      type: object
      required: [testId, name, displayOrder]
      properties:
        testId:
          type: string
        name:
          type: string
        userCode:
          type: string
          nullable: true
        loincCode:
          type: string
          nullable: true
        displayOrder:
          type: integer
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/TestDefinitionParameter'

    ImportJob:
      type: object
      required: [id, tenantId, status, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        status:
          type: string
          enum: [pending, validating, validated, applying, applied, failed]
        mode:
          type: string
          enum: [CREATE_ONLY, UPSERT_PATCH]
        summary:
          type: object
          nullable: true
          properties:
            inserted:
              type: integer
            updated:
              type: integer
            skipped:
              type: integer
            errors:
              type: integer
        errorCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    ExportJob:
      type: object
      required: [id, tenantId, status, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        format:
          type: string
          enum: [xlsx, csv]
        downloadUrl:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    ReferenceRange:
      type: object
      required: [id, tenantId, parameterId]
      properties:
        id:
          type: string
        tenantId:
          type: string
        parameterId:
          type: string
        testId:
          type: string
        gender:
          type: string
          enum: [M, F]
          nullable: true
        ageMinYears:
          type: integer
          nullable: true
        ageMaxYears:
          type: integer
          nullable: true
        lowValue:
          type: number
          nullable: true
        highValue:
          type: number
          nullable: true
        criticalLow:
          type: number
          nullable: true
        criticalHigh:
          type: number
          nullable: true
        unit:
          type: string

    JobRun:
      type: object
      required: [id, tenantId, type, status, correlationId, createdBy, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        type:
          type: string
          enum: [catalog.import, catalog.export]
        status:
          type: string
          enum: [queued, running, completed, failed]
        payloadHash:
          type: string
          nullable: true
        correlationId:
          type: string
        startedAt:
          type: string
          format: date-time
          nullable: true
        finishedAt:
          type: string
          format: date-time
          nullable: true
        resultSummary:
          type: object
          nullable: true
          properties:
            created:
              type: integer
            updated:
              type: integer
            skipped:
              type: integer
            total:
              type: integer
        errorSummary:
          type: string
          nullable: true
        createdBy:
          type: string
        createdAt:
          type: string
          format: date-time

    CatalogImportPayload:
      type: object
      properties:
        tests:
          type: array
          items:
            type: object
            required: [code, name]
            properties:
              code:
                type: string
              name:
                type: string
              description:
                type: string
              sampleType:
                type: string
              turnaroundHours:
                type: integer
              price:
                type: number
                minimum: 0
                nullable: true
        parameters:
          type: array
          items:
            type: object
            required: [code, name]
            properties:
              code:
                type: string
              name:
                type: string
              unit:
                type: string
              dataType:
                type: string
                enum: [numeric, text, boolean, coded]
        panels:
          type: array
          items:
            type: object
            required: [code, name]
            properties:
              code:
                type: string
              name:
                type: string
              description:
                type: string
              price:
                type: number
                minimum: 0
                nullable: true
        mappings:
          type: array
          items:
            type: object
            properties:
              testCode:
                type: string
              parameterCode:
                type: string
              ordering:
                type: integer

    AuditEvent:
      type: object
      required: [id, tenantId, action, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        actorUserId:
          type: string
        action:
          type: string
        entityType:
          type: string
        entityId:
          type: string
        correlationId:
          type: string
        before:
          type: object
          nullable: true
        after:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time

    Job:
      type: object
      required: [id, queue, status]
      properties:
        id:
          type: string
        queue:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [waiting, active, completed, failed, delayed]
        data:
          type: object
        failedReason:
          type: string
          nullable: true
        attemptsMade:
          type: integer
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time
          nullable: true

    PermissionKey:
      type: string
      enum:
        - admin.super
        - tenant.read
        - tenant.create
        - tenant.update
        - user.read
        - user.create
        - user.update
        - user.disable
        - role.read
        - role.create
        - role.update
        - role.delete
        - role.assign
        - feature_flag.read
        - feature_flag.set
        - catalog.read
        - catalog.write
        - catalog.manage
        - audit.read
        - job.read
        - job.retry
        - branding.read
        - branding.write
        - patient.manage
        - encounter.manage
        - result.enter
        - result.verify

    Patient:
      type: object
      required: [id, tenantId, firstName, lastName, mrn, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
          nullable: true
        ageYears:
          type: integer
          nullable: true
        gender:
          type: string
          nullable: true
        mrn:
          type: string
        mobile:
          type: string
          nullable: true
        cnic:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Encounter:
      type: object
      required: [id, tenantId, patientId, status, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        patientId:
          type: string
        encounterCode:
          type: string
          nullable: true
          description: "LIMS Order ID e.g. VXL-2602-001"
        status:
          type: string
          enum: [registered, lab_ordered, specimen_collected, specimen_received, partial_resulted, resulted, verified, cancelled]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        patient:
          $ref: '#/components/schemas/Patient'
        labOrders:
          type: array
          items:
            $ref: '#/components/schemas/LabOrder'
        specimenItems:
          type: array
          items:
            $ref: '#/components/schemas/SpecimenItem'

    LabOrder:
      type: object
      required: [id, tenantId, encounterId, testId, status, resultStatus, priority, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        encounterId:
          type: string
        testId:
          type: string
        testNameSnapshot:
          type: string
          nullable: true
        test:
          type: object
          description: Resolved test definition (populated when available)
          nullable: true
          properties:
            id:
              type: string
            code:
              type: string
            name:
              type: string
            specimenType:
              type: string
              nullable: true
            loincCode:
              type: string
              nullable: true
        status:
          type: string
          enum: [ordered, specimen_collected, processing, resulted, verified, cancelled]
        resultStatus:
          type: string
          enum: [PENDING, SUBMITTED]
          default: PENDING
        priority:
          type: string
          enum: [routine, stat, urgent]
        submittedAt:
          type: string
          format: date-time
          nullable: true
        submittedById:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        specimen:
          $ref: '#/components/schemas/Specimen'
        results:
          type: array
          items:
            $ref: '#/components/schemas/LabResult'

    Specimen:
      type: object
      required: [id, tenantId, labOrderId, barcode, type, status, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        labOrderId:
          type: string
        barcode:
          type: string
        type:
          type: string
        collectedAt:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [pending, collected, received, rejected]
        createdAt:
          type: string
          format: date-time

    LabResult:
      type: object
      required: [id, tenantId, labOrderId, value, enteredAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        labOrderId:
          type: string
        parameterId:
          type: string
          nullable: true
        parameterNameSnapshot:
          type: string
          nullable: true
        value:
          type: string
        unit:
          type: string
          nullable: true
        referenceRange:
          type: string
          nullable: true
        flag:
          type: string
          enum: [normal, high, low, critical]
          nullable: true
        locked:
          type: boolean
          default: false
        enteredAt:
          type: string
          format: date-time
        enteredById:
          type: string
          nullable: true
        verifiedAt:
          type: string
          format: date-time
          nullable: true
        verifiedBy:
          type: string
          nullable: true

    SpecimenItem:
      type: object
      required: [id, tenantId, encounterId, catalogSpecimenType, status, createdAt]
      properties:
        id:
          type: string
        tenantId:
          type: string
        encounterId:
          type: string
        catalogSpecimenType:
          type: string
          description: "Exact specimen type e.g. 'EDTA Blood', 'Urine'"
        status:
          type: string
          enum: [PENDING, COLLECTED, POSTPONED, RECEIVED]
        barcode:
          type: string
          nullable: true
        collectedAt:
          type: string
          format: date-time
          nullable: true
        collectedById:
          type: string
          nullable: true
        postponedAt:
          type: string
          format: date-time
          nullable: true
        postponeReason:
          type: string
          nullable: true
        receivedAt:
          type: string
          format: date-time
          nullable: true
        receivedById:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TestParameter:
      type: object
      description: A catalog parameter definition with current value for results entry
      properties:
        parameterId:
          type: string
        name:
          type: string
        unit:
          type: string
          nullable: true
        dataType:
          type: string
          enum: [number, text, select, boolean]
          default: number
        allowedValues:
          type: array
          items:
            type: string
          nullable: true
          description: For dataType=select
        referenceRange:
          type: string
          nullable: true
        value:
          type: string
          nullable: true
          description: Current entered value (if any)
        flag:
          type: string
          enum: [normal, high, low, critical]
          nullable: true
        locked:
          type: boolean
          default: false
          description: True if test submitted and value is non-empty

    OrderedTestDetail:
      type: object
      description: Full detail for one test (LabOrder) including parameter schema and current values
      required: [id, encounterId, testId, testName, resultStatus]
      properties:
        id:
          type: string
          description: LabOrder ID (orderedTestId)
        encounterId:
          type: string
        encounterCode:
          type: string
          nullable: true
        testId:
          type: string
        testName:
          type: string
        resultStatus:
          type: string
          enum: [PENDING, SUBMITTED]
        submittedAt:
          type: string
          format: date-time
          nullable: true
        patient:
          $ref: '#/components/schemas/Patient'
        specimenStatus:
          type: string
          description: "Status of the specimen for entry gating"
          nullable: true
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/TestParameter'

    OrderedTestSummary:
      type: object
      description: Row item for results worklist
      required: [id, encounterId, testName, resultStatus, createdAt]
      properties:
        id:
          type: string
          description: LabOrder ID
        encounterId:
          type: string
        encounterCode:
          type: string
          nullable: true
        testId:
          type: string
        testName:
          type: string
        resultStatus:
          type: string
          enum: [PENDING, SUBMITTED]
        submittedAt:
          type: string
          format: date-time
          nullable: true
        filledCount:
          type: integer
          description: Number of parameters with values entered
        totalCount:
          type: integer
          description: Total number of parameters in this test
        specimenStatus:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        patient:
          $ref: '#/components/schemas/Patient'

    VerificationEncounterSummary:
      type: object
      description: Row item for verification worklist
      required: [encounterId, submittedTestsCount, createdAt]
      properties:
        encounterId:
          type: string
        encounterCode:
          type: string
          nullable: true
        submittedTestsCount:
          type: integer
        oldestSubmittedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        patient:
          $ref: '#/components/schemas/Patient'

    VerificationTestCard:
      type: object
      description: One test with only filled parameters for verification preview
      required: [labOrderId, testName, resultStatus]
      properties:
        labOrderId:
          type: string
        testName:
          type: string
        resultStatus:
          type: string
          enum: [SUBMITTED, VERIFIED]
        submittedAt:
          type: string
          format: date-time
          nullable: true
        filledParameters:
          type: array
          items:
            type: object
            properties:
              parameterId:
                type: string
                nullable: true
              name:
                type: string
              value:
                type: string
              unit:
                type: string
                nullable: true
              referenceRange:
                type: string
                nullable: true
              flag:
                type: string
                enum: [normal, high, low, critical]
                nullable: true

    SampleCollectionEncounter:
      type: object
      description: Row item for sample collection worklist
      required: [encounterId, pendingCount, totalCount, createdAt]
      properties:
        encounterId:
          type: string
        encounterCode:
          type: string
          nullable: true
        pendingCount:
          type: integer
        totalCount:
          type: integer
        testsCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        patient:
          $ref: '#/components/schemas/Patient'
        specimenItems:
          type: array
          items:
            $ref: '#/components/schemas/SpecimenItem'

    Document:
      type: object
      properties:
        id:
          type: string
        tenantId:
          type: string
        type:
          type: string
          enum: [RECEIPT, LAB_REPORT]
        templateId:
          type: string
        payloadHash:
          type: string
        pdfHash:
          type: string
          nullable: true
        status:
          type: string
          enum: [DRAFT, RENDERING, RENDERED, PUBLISHED, FAILED]
        version:
          type: integer
        sourceRef:
          type: string
          nullable: true
        sourceType:
          type: string
          nullable: true
        errorMessage:
          type: string
          nullable: true
        publishedAt:
          type: string
          format: date-time
          nullable: true
        createdBy:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    DocumentTemplate:
      type: object
      properties:
        id:
          type: string
        tenantId:
          type: string
        type:
          type: string
          enum: [RECEIPT, LAB_REPORT]
        templateKey:
          type: string
        version:
          type: integer
        config:
          type: object
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ReceiptGenerateRequest:
      type: object
      required: [receiptNumber, patientName, patientMrn, issuedAt, items, subtotal, tax, grandTotal]
      properties:
        receiptNumber:
          type: string
        patientName:
          type: string
        patientMrn:
          type: string
        issuedAt:
          type: string
          format: date-time
        items:
          type: array
          items:
            type: object
            required: [description, quantity, unitPrice, total]
            properties:
              description:
                type: string
              quantity:
                type: number
              unitPrice:
                type: number
              total:
                type: number
        subtotal:
          type: number
        tax:
          type: number
        grandTotal:
          type: number
        sourceRef:
          type: string
          nullable: true
        sourceType:
          type: string
          nullable: true

    ReportGenerateRequest:
      type: object
      required: [reportNumber, patientName, patientMrn, encounterId, tests]
      properties:
        reportNumber:
          type: string
        patientName:
          type: string
        patientMrn:
          type: string
        patientDob:
          type: string
          nullable: true
        patientGender:
          type: string
          nullable: true
        encounterId:
          type: string
        orderedBy:
          type: string
          nullable: true
        tests:
          type: array
          items:
            type: object
            required: [testCode, testName, parameters]
            properties:
              testCode:
                type: string
              testName:
                type: string
              parameters:
                type: array
                items:
                  type: object
                  required: [parameterCode, parameterName, value]
                  properties:
                    parameterCode:
                      type: string
                    parameterName:
                      type: string
                    value:
                      type: string
                    unit:
                      type: string
                      nullable: true
                    referenceRange:
                      type: string
                      nullable: true
                    flag:
                      type: string
                      enum: [normal, high, low, critical]
                      nullable: true
        verifiedBy:
          type: string
          nullable: true
        verifiedAt:
          type: string
          format: date-time
          nullable: true
        sourceRef:
          type: string
          nullable: true
        sourceType:
          type: string
          nullable: true

paths:
  # ─── Health ───────────────────────────────────────────────────────────────
  /health:
    get:
      operationId: getHealth
      summary: API health check
      security: []
      tags: [Health]
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
      responses:
        "200":
          description: Service is healthy
          headers:
            X-Correlation-ID:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /health/worker:
    get:
      operationId: getWorkerHealth
      summary: Worker health check
      security: []
      tags: [Health]
      responses:
        "200":
          description: Worker is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /health/pdf:
    get:
      operationId: getPdfHealth
      summary: PDF service health check
      security: []
      tags: [Health]
      responses:
        "200":
          description: PDF service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  # ─── Auth ─────────────────────────────────────────────────────────────────
  /auth/login:
    post:
      operationId: login
      summary: Login (admin or operator)
      security: []
      tags: [Auth]
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      operationId: refreshToken
      summary: Refresh access token
      security: []
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        "200":
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        "401":
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      operationId: logout
      summary: Logout (revoke refresh token)
      tags: [Auth]
      responses:
        "204":
          description: Logged out successfully

  /me:
    get:
      operationId: getMe
      summary: Get current authenticated user
      tags: [Auth]
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSummary'

  # ─── Tenants ──────────────────────────────────────────────────────────────
  /tenants:
    get:
      operationId: listTenants
      summary: List tenants (super-admin only)
      tags: [Tenants]
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TenantSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createTenant
      summary: Create a new tenant (super-admin only)
      tags: [Tenants]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, domains]
              properties:
                name:
                  type: string
                domains:
                  type: array
                  items:
                    type: string
                status:
                  type: string
                  enum: [active, suspended, trial]
                  default: trial
      responses:
        "201":
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantSummary'
        "409":
          description: Domain already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tenants/{tenantId}:
    get:
      operationId: getTenant
      summary: Get tenant by ID
      tags: [Tenants]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tenant detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantSummary'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updateTenant
      summary: Update tenant
      tags: [Tenants]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                domains:
                  type: array
                  items:
                    type: string
                status:
                  type: string
                  enum: [active, suspended, trial]
      responses:
        "200":
          description: Updated tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantSummary'

  /tenants/{tenantId}/config:
    get:
      operationId: getTenantConfig
      summary: Get tenant branding/config
      tags: [Tenants]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tenant config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantConfig'
    patch:
      operationId: updateTenantConfig
      summary: Update tenant branding/config
      tags: [Tenants]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantConfig'
      responses:
        "200":
          description: Updated config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantConfig'

  /tenants/{tenantId}/feature-flags:
    get:
      operationId: getTenantFeatureFlags
      summary: Get feature flags for a tenant
      tags: [FeatureFlags]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Feature flags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureFlag'
    put:
      operationId: setTenantFeatureFlags
      summary: Set feature flags for a tenant
      tags: [FeatureFlags]
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                required: [key, enabled]
                properties:
                  key:
                    type: string
                  enabled:
                    type: boolean
      responses:
        "200":
          description: Updated feature flags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureFlag'

  # ─── Users ────────────────────────────────────────────────────────────────
  /users:
    get:
      operationId: listUsers
      summary: List users (tenant-scoped)
      tags: [Users]
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          schema:
            type: string
            enum: [active, disabled, pending]
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createUser
      summary: Create a new user (tenant-scoped)
      tags: [Users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, firstName, lastName, password]
              properties:
                email:
                  type: string
                  format: email
                firstName:
                  type: string
                lastName:
                  type: string
                password:
                  type: string
                roles:
                  type: array
                  items:
                    type: string
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSummary'
        "409":
          description: Email already in use within tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{userId}:
    get:
      operationId: getUser
      summary: Get user by ID
      tags: [Users]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: User detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSummary'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updateUser
      summary: Update user (name, status)
      tags: [Users]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                status:
                  type: string
                  enum: [active, disabled]
      responses:
        "200":
          description: Updated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSummary'

  /users/{userId}/roles:
    get:
      operationId: getUserRoles
      summary: Get roles assigned to user
      tags: [Users]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: User roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
    put:
      operationId: setUserRoles
      summary: Set roles for user (replaces current assignment)
      tags: [Users]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [roleIds]
              properties:
                roleIds:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Updated roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

  # ─── Roles ────────────────────────────────────────────────────────────────
  /roles:
    get:
      operationId: listRoles
      summary: List roles (tenant-scoped)
      tags: [Roles]
      responses:
        "200":
          description: Roles list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
    post:
      operationId: createRole
      summary: Create a role
      tags: [Roles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                permissions:
                  type: array
                  items:
                    type: string
      responses:
        "201":
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'

  /roles/{roleId}:
    patch:
      operationId: updateRole
      summary: Update a role
      tags: [Roles]
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                permissions:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Updated role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'

  /roles/permissions:
    get:
      operationId: listPermissions
      summary: List all available system permissions
      tags: [Roles]
      responses:
        "200":
          description: All permission keys
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  # ─── Feature Flags (global / system) ──────────────────────────────────────
  /feature-flags/resolved:
    get:
      operationId: getResolvedFeatureFlags
      summary: Get resolved feature flags for current tenant (JWT auth only — no special permission required)
      description: Returns merged flag values (DB overrides + defaults) for the current tenant. Used by Operator/Admin UI for gating.
      tags: [FeatureFlags]
      responses:
        "200":
          description: Resolved flags as key-value map
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
                example:
                  lims.verification.enabled: true
                  lims.verification.mode: { mode: "separate" }
                  lims.operator.sample.receiveSeparate.enabled: false
        "401":
          $ref: '#/components/responses/Unauthorized'

  /feature-flags:
    get:
      operationId: listFeatureFlags
      summary: List all feature flag keys and their descriptions
      tags: [FeatureFlags]
      responses:
        "200":
          description: All feature flags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FeatureFlag'

  /feature-flags/{key}:
    put:
      operationId: setFeatureFlag
      summary: Enable or disable a feature flag system-wide
      tags: [FeatureFlags]
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [enabled]
              properties:
                enabled:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureFlag'

  # ─── Catalog ──────────────────────────────────────────────────────────────
  /catalog/tests:
    get:
      operationId: listCatalogTests
      summary: List catalog tests (tenant-scoped)
      tags: [Catalog]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: search
          in: query
          schema:
            type: string
          description: Search by name, userCode, externalId, or loincCode
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Catalog tests
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CatalogTest'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createCatalogTest
      summary: Create a catalog test
      tags: [Catalog]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                sampleType:
                  type: string
                turnaroundHours:
                  type: integer
                price:
                  type: number
                  minimum: 0
                  nullable: true
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogTest'

  /catalog/tests/{testId}:
    get:
      operationId: getCatalogTest
      summary: Get catalog test
      tags: [Catalog]
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Catalog test
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogTest'
    patch:
      operationId: updateCatalogTest
      summary: Update catalog test
      tags: [Catalog]
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                sampleType:
                  type: string
                turnaroundHours:
                  type: integer
                price:
                  type: number
                  minimum: 0
                  nullable: true
                isActive:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogTest'
    delete:
      operationId: deleteCatalogTest
      summary: Delete (deactivate) catalog test
      tags: [Catalog]
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  /catalog/panels:
    get:
      operationId: listCatalogPanels
      summary: List catalog panels (tenant-scoped)
      tags: [Catalog]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: search
          in: query
          schema:
            type: string
          description: Search by name, userCode, externalId, or loincCode
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Catalog panels
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CatalogPanel'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createCatalogPanel
      summary: Create a catalog panel
      tags: [Catalog]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                  minimum: 0
                  nullable: true
                testIds:
                  type: array
                  items:
                    type: string
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogPanel'

  /catalog/panels/{panelId}:
    patch:
      operationId: updateCatalogPanel
      summary: Update catalog panel
      tags: [Catalog]
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                  minimum: 0
                  nullable: true
                isActive:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogPanel'

  # ─── Catalog Parameters ───────────────────────────────────────────────────
  /catalog/parameters:
    get:
      operationId: listParameters
      summary: List parameters (tenant-scoped)
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: search
          in: query
          schema:
            type: string
          description: Search by name, userCode, externalId, or loincCode
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Parameters list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Parameter'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      operationId: createParameter
      summary: Create a parameter
      tags: [Catalog]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                unit:
                  type: string
                dataType:
                  type: string
                  enum: [numeric, text, boolean, coded]
                defaultValue:
                  type: string
                  nullable: true
      responses:
        "201":
          description: Parameter created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Parameter'
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/parameters/{parameterId}:
    get:
      operationId: getParameter
      summary: Get parameter by ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: parameterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Parameter'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      operationId: updateParameter
      summary: Update parameter
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: parameterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                unit:
                  type: string
                dataType:
                  type: string
                isActive:
                  type: boolean
                defaultValue:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Parameter updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Parameter'

  /catalog/tests/{testId}/parameters:
    get:
      operationId: listTestParameters
      summary: List parameter mappings for a test
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test parameter mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TestParameterMapping'
    post:
      operationId: addTestParameter
      summary: Add parameter mapping to test
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parameterId]
              properties:
                parameterId:
                  type: string
                displayOrder:
                  type: integer

  /catalog/tests/{testId}/parameters/{parameterId}:
    patch:
      operationId: updateTestParameterMapping
      summary: Update parameter mapping for a test
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema: { type: string }
        - name: parameterId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayOrder: { type: integer }
                isRequired: { type: boolean }
                unitOverride: { type: string, nullable: true }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestParameterMappingResponse'
    delete:
      operationId: removeTestParameter
      summary: Remove parameter mapping from test
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
        - name: parameterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Mapping removed

  /catalog/panels/{panelId}/tests:
    get:
      operationId: listPanelTests
      summary: List test mappings for a panel
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Panel test mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PanelTestMapping'
    post:
      operationId: addPanelTest
      summary: Add test mapping to panel
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [testId]
              properties:
                testId:
                  type: string
                displayOrder:
                  type: integer
      responses:
        "201":
          description: Mapping created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanelTestMapping'

  /catalog/panels/{panelId}/tests/{testId}:
    delete:
      operationId: removePanelTest
      summary: Remove test mapping from panel
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Mapping removed

  /catalog/tests/{testId}/definition:
    get:
      operationId: getTestDefinition
      summary: Get complete ordered test definition (for operator use)
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test definition with ordered parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestDefinition'
        "404":
          $ref: '#/components/responses/NotFound'

  /catalog/panels/{panelId}/definition:
    get:
      operationId: getPanelDefinition
      summary: Get complete ordered panel definition (for operator use)
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Panel definition with ordered tests and parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanelDefinition'
        "404":
          $ref: '#/components/responses/NotFound'

  /catalog/tests/{testId}/parameters:bulk:
    put:
      operationId: bulkUpdateTestParameters
      summary: Bulk update ordered parameter mappings for a test
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: testId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [mode, items]
              properties:
                mode:
                  type: string
                  enum: [MERGE_UPSERT, REPLACE]
                  default: MERGE_UPSERT
                items:
                  type: array
                  items:
                    type: object
                    required: [displayOrder]
                    properties:
                      parameterId:
                        type: string
                      parameterExternalId:
                        type: string
                      parameterUserCode:
                        type: string
                      displayOrder:
                        type: integer
                      isRequired:
                        type: boolean
                        default: true
                      unitOverride:
                        type: string
                        nullable: true
      responses:
        "200":
          description: Updated mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TestParameterMapping'

  /catalog/panels/{panelId}/tests:bulk:
    put:
      operationId: bulkUpdatePanelTests
      summary: Bulk update ordered test mappings for a panel
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: panelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [mode, items]
              properties:
                mode:
                  type: string
                  enum: [MERGE_UPSERT, REPLACE]
                  default: MERGE_UPSERT
                items:
                  type: array
                  items:
                    type: object
                    required: [displayOrder]
                    properties:
                      testId:
                        type: string
                      testExternalId:
                        type: string
                      testUserCode:
                        type: string
                      displayOrder:
                        type: integer
      responses:
        "200":
          description: Updated mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PanelTestMapping'

  /catalog/import-jobs/{id}:validate:
    post:
      operationId: validateCatalogImportJob
      summary: Dry-run validate an import job (preview diff)
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Validation result with diff preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportJob'

  /catalog/import-jobs/{id}:apply:
    post:
      operationId: applyCatalogImportJob
      summary: Apply a validated import job
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Applied import job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportJob'

  /catalog/import-jobs/{id}/errors:
    get:
      operationId: getCatalogImportJobErrors
      summary: Download import job errors as JSON
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Error list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /catalog/export-jobs/{id}/download:
    get:
      operationId: downloadCatalogExport
      summary: Download completed export file
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Export file download
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /catalog/templates/workbook.xlsx:
    get:
      operationId: downloadCatalogWorkbookTemplate
      summary: Download all-in-one XLSX workbook template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: XLSX workbook template
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /catalog/templates/parameters.csv:
    get:
      operationId: downloadParametersTemplate
      summary: Download parameters CSV template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: CSV template
          content:
            text/csv:
              schema:
                type: string

  /catalog/templates/tests.csv:
    get:
      operationId: downloadTestsTemplate
      summary: Download tests CSV template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: CSV template
          content:
            text/csv:
              schema:
                type: string

  /catalog/templates/test-parameters.csv:
    get:
      operationId: downloadTestParametersTemplate
      summary: Download test-parameters mapping CSV template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: CSV template
          content:
            text/csv:
              schema:
                type: string

  /catalog/templates/panels.csv:
    get:
      operationId: downloadPanelsTemplate
      summary: Download panels CSV template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: CSV template
          content:
            text/csv:
              schema:
                type: string

  /catalog/templates/panel-tests.csv:
    get:
      operationId: downloadPanelTestsTemplate
      summary: Download panel-tests mapping CSV template
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: CSV template
          content:
            text/csv:
              schema:
                type: string

  /catalog/tests/next-id:
    get:
      operationId: getNextTestId
      summary: Get next available test external ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextId:
                    type: string

  /catalog/parameters/next-id:
    get:
      operationId: getNextParameterId
      summary: Get next available parameter external ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextId:
                    type: string

  /catalog/panels/next-id:
    get:
      operationId: getNextPanelId
      summary: Get next available panel external ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextId:
                    type: string

  /catalog/test-parameter-mappings/import:
    post:
      operationId: importTestParameterMappings
      summary: Import test-parameter mappings from CSV
      tags: [Catalog]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [csv]
              properties:
                csv:
                  type: string
                  description: CSV text content (first col = test externalId, rest = param externalIds)
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported: { type: integer }
                  skipped: { type: integer }
                  warnings:
                    type: array
                    items:
                      type: object
                      properties:
                        row: { type: integer }
                        message: { type: string }

  # ─── Catalog Reference Ranges ──────────────────────────────────────────────
  /catalog/reference-ranges:
    get:
      operationId: listReferenceRanges
      summary: List reference ranges (tenant-scoped)
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: parameterId
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Reference ranges
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReferenceRange'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createReferenceRange
      summary: Create reference range
      tags: [Catalog]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReferenceRange'
      responses:
        "201":
          description: Reference range created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferenceRange'

  /catalog/reference-ranges/{id}:
    put:
      operationId: updateReferenceRange
      summary: Update reference range
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReferenceRange'
      responses:
        "200":
          description: Reference range updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferenceRange'
    delete:
      operationId: deleteReferenceRange
      summary: Delete reference range
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  # ─── Catalog Import/Export Jobs ────────────────────────────────────────────
  /catalog/import-jobs:
    post:
      operationId: createImportJob
      summary: Start a catalog import job (idempotent by payloadHash)
      tags: [Catalog]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CatalogImportPayload'
      responses:
        "201":
          description: Import job created or existing returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobRun'
        "403":
          description: Feature disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      operationId: listImportJobs
      summary: List import jobs
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Import jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/JobRun'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /catalog/import-jobs/{id}:
    get:
      operationId: getImportJob
      summary: Get import job by ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Import job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobRun'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/import-jobs/{id}:retry:
    post:
      operationId: retryImportJob
      summary: Retry a failed import job
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job re-queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobRun'
        "409":
          description: Job is not in failed state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /catalog/export-jobs:
    post:
      operationId: createExportJob
      summary: Start a catalog export job
      tags: [Catalog]
      security:
        - bearerAuth: []
      responses:
        "201":
          description: Export job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobRun'
    get:
      operationId: listExportJobs
      summary: List export jobs
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Export jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/JobRun'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /catalog/export-jobs/{id}:
    get:
      operationId: getExportJob
      summary: Get export job by ID
      tags: [Catalog]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Export job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobRun'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Audit Events ─────────────────────────────────────────────────────────
  /audit-events:
    get:
      operationId: listAuditEvents
      summary: List audit events (with filters)
      tags: [Audit]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: tenantId
          in: query
          schema:
            type: string
        - name: actorUserId
          in: query
          schema:
            type: string
        - name: entityType
          in: query
          schema:
            type: string
        - name: entityId
          in: query
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
        - name: correlationId
          in: query
          schema:
            type: string
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: Audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  # ─── Jobs ─────────────────────────────────────────────────────────────────
  /jobs:
    get:
      operationId: listJobs
      summary: List jobs across all queues
      tags: [Jobs]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: queue
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [waiting, active, completed, failed, delayed]
      responses:
        "200":
          description: Jobs list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /jobs/failed:
    get:
      operationId: listFailedJobs
      summary: List failed jobs
      tags: [Jobs]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Failed jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /jobs/failed-count:
    get:
      operationId: getFailedJobsCount
      summary: Get count of failed jobs (for dashboard)
      tags: [Jobs]
      responses:
        "200":
          description: Failed jobs count
          content:
            application/json:
              schema:
                type: object
                required: [count]
                properties:
                  count:
                    type: integer

  /jobs/{jobId}:retry:
    post:
      operationId: retryJob
      summary: Retry a failed job (audited command)
      tags: [Jobs]
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job re-queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        "404":
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: Job is not in a failed state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Patients ─────────────────────────────────────────────────────────────
  /patients:
    get:
      operationId: listPatients
      summary: List patients (tenant-scoped)
      tags: [Patients]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: lastName
          in: query
          schema:
            type: string
        - name: mrn
          in: query
          schema:
            type: string
        - name: mobile
          in: query
          schema:
            type: string
          description: Search by mobile number (exact or partial match)
      responses:
        "200":
          description: Patients list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Patient'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createPatient
      summary: Create a patient record
      tags: [Patients]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [firstName, lastName]
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                dateOfBirth:
                  type: string
                  format: date
                ageYears:
                  type: integer
                gender:
                  type: string
                mobile:
                  type: string
                cnic:
                  type: string
                address:
                  type: string
                mrn:
                  type: string
                  description: "If omitted, server generates from tenant prefix"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        "409":
          description: MRN already exists in tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /patients/{patientId}:
    get:
      operationId: getPatient
      summary: Get patient by ID
      tags: [Patients]
      parameters:
        - name: patientId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Patient record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      operationId: updatePatient
      summary: Update patient record
      tags: [Patients]
      parameters:
        - name: patientId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                dateOfBirth:
                  type: string
                  format: date
                gender:
                  type: string
      responses:
        "200":
          description: Updated patient
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Encounters ───────────────────────────────────────────────────────────
  /encounters:
    get:
      operationId: listEncounters
      summary: List encounters (tenant-scoped)
      tags: [Encounters]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          schema:
            type: string
        - name: patientId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Encounters list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Encounter'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
    post:
      operationId: createEncounter
      summary: Register a new encounter
      tags: [Encounters]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [patientId]
              properties:
                patientId:
                  type: string
      responses:
        "201":
          description: Encounter registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'

  /encounters/{encounterId}:
    get:
      operationId: getEncounter
      summary: Get encounter by ID
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Encounter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /encounters/{encounterId}:order-lab:
    post:
      operationId: orderLab
      summary: Add a lab order to encounter
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [testId]
              properties:
                testId:
                  type: string
                priority:
                  type: string
                  enum: [routine, stat, urgent]
                  default: routine
      responses:
        "200":
          description: Lab ordered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /encounters/{encounterId}:collect-specimen:
    post:
      operationId: collectSpecimen
      summary: Mark specimen as collected
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [labOrderId, barcode, type]
              properties:
                labOrderId:
                  type: string
                barcode:
                  type: string
                type:
                  type: string
      responses:
        "200":
          description: Specimen collected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /encounters/{encounterId}:result:
    post:
      operationId: enterResult
      summary: Enter lab result
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [labOrderId, value]
              properties:
                labOrderId:
                  type: string
                value:
                  type: string
                unit:
                  type: string
                referenceRange:
                  type: string
                flag:
                  type: string
                  enum: [normal, high, low, critical]
      responses:
        "200":
          description: Result entered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /encounters/{encounterId}:verify:
    post:
      operationId: verifyEncounterLegacy
      deprecated: true
      summary: "(deprecated) Verify lab results — use POST /verification/encounters/{encounterId}:verify instead"
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Encounter verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /encounters/{encounterId}:cancel:
    post:
      operationId: cancelEncounter
      summary: Cancel encounter
      tags: [Encounters]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Encounter cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Documents ────────────────────────────────────────────────────────────
  /documents/receipt:generate:
    post:
      operationId: generateReceipt
      summary: Generate a receipt document (idempotent by payload hash)
      tags: [Documents]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReceiptGenerateRequest'
      responses:
        "200":
          description: Existing document returned (idempotent — same payloadHash)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "201":
          description: New document created and queued for render
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /documents/report:generate:
    post:
      operationId: generateReport
      summary: Generate a lab report document (idempotent by payload hash)
      tags: [Documents]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportGenerateRequest'
      responses:
        "200":
          description: Existing document returned (idempotent — same payloadHash)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "201":
          description: New document created and queued for render
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /documents:
    get:
      operationId: listDocuments
      summary: List documents for the current tenant
      tags: [Documents]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [DRAFT, RENDERING, RENDERED, PUBLISHED, FAILED]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: encounterId
          in: query
          schema:
            type: string
          description: Filter documents by encounter ID
        - name: docType
          in: query
          schema:
            type: string
            enum: [RECEIPT, LAB_REPORT]
          description: Filter by document type
      responses:
        "200":
          description: Documents list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Document'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'

  /documents/{id}:
    get:
      operationId: getDocument
      summary: Get a document by ID
      tags: [Documents]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Document details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  /documents/{id}:publish:
    post:
      operationId: publishDocument
      summary: Publish a RENDERED document (idempotent)
      tags: [Documents]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Document published (or already published)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
        "409":
          description: Document not in RENDERED status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /documents/{id}/download:
    get:
      operationId: downloadDocument
      summary: Download PDF bytes or redirect to signed URL
      tags: [Documents]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: PDF download or placeholder response
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                type: object
                properties:
                  documentId:
                    type: string
                  pdfHash:
                    type: string
                    nullable: true
                  message:
                    type: string
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  # ─── Sample Collection ────────────────────────────────────────────

  /sample-collection/worklist:
    get:
      operationId: getSampleCollectionWorklist
      summary: List encounters with pending specimen items
      tags: [SampleCollection]
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, POSTPONED, RECEIVED]
            default: PENDING
        - name: fromDate
          in: query
          schema:
            type: string
            format: date
          description: "Default: 3 days ago"
        - name: toDate
          in: query
          schema:
            type: string
            format: date
        - name: search
          in: query
          schema:
            type: string
          description: Search by MRN, patient name, or encounter code
      responses:
        "200":
          description: Sample collection worklist
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SampleCollectionEncounter'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'

  /encounters/{encounterId}:collect-specimens:
    post:
      operationId: collectSpecimens
      summary: Batch collect specimen items for an encounter
      tags: [SampleCollection]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                specimenItemIds:
                  type: array
                  items:
                    type: string
                  description: "IDs of SpecimenItems to collect; empty = collect all PENDING"
      responses:
        "200":
          description: Specimens collected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "409":
          description: Invalid state or no pending specimens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  /encounters/{encounterId}:postpone-specimen:
    post:
      operationId: postponeSpecimen
      summary: Postpone a specimen item with a reason
      tags: [SampleCollection]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [specimenItemId, reason]
              properties:
                specimenItemId:
                  type: string
                reason:
                  type: string
                  minLength: 3
      responses:
        "200":
          description: Specimen postponed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpecimenItem'
        "409":
          description: Specimen not in postponable state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  /encounters/{encounterId}:receive-specimens:
    post:
      operationId: receiveSpecimens
      summary: Batch receive specimen items (requires lims.operator.sample.receiveSeparate.enabled)
      tags: [SampleCollection]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                specimenItemIds:
                  type: array
                  items:
                    type: string
                  description: "IDs of SpecimenItems to receive; empty = receive all COLLECTED"
      responses:
        "200":
          description: Specimens received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Encounter'
        "403":
          description: Feature flag disabled for tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "404":
          $ref: '#/components/responses/NotFound'

  # ─── Results (test-level) ─────────────────────────────────────────

  /results/tests/pending:
    get:
      operationId: getPendingTests
      summary: List tests pending result entry
      tags: [Results]
      parameters:
        - name: search
          in: query
          schema:
            type: string
          description: Search by MRN, patient name, order code, or test name
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Pending tests worklist
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderedTestSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'

  /results/tests/submitted:
    get:
      operationId: getSubmittedTests
      summary: List tests submitted for verification
      tags: [Results]
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: fromDate
          in: query
          schema:
            type: string
            format: date
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Submitted tests list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderedTestSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'

  /results/tests/{orderedTestId}:
    get:
      operationId: getOrderedTestDetail
      summary: Get test detail with parameter schema and current values
      tags: [Results]
      parameters:
        - name: orderedTestId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Ordered test with parameter values and lock state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderedTestDetail'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  /results/tests/{orderedTestId}:save:
    post:
      operationId: saveTestResults
      summary: Save draft result values for a test (does not change status)
      tags: [Results]
      parameters:
        - name: orderedTestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [values]
              properties:
                values:
                  type: array
                  items:
                    type: object
                    required: [parameterId, value]
                    properties:
                      parameterId:
                        type: string
                      value:
                        type: string
      responses:
        "200":
          description: Values saved; test still in current status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderedTestDetail'
        "403":
          description: Sample not collected; entry blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          $ref: '#/components/responses/NotFound'
        "401":
          $ref: '#/components/responses/Unauthorized'

  /results/tests/{orderedTestId}:submit:
    post:
      operationId: submitTestResults
      summary: Submit test results for verification (locks non-empty values)
      tags: [Results]
      parameters:
        - name: orderedTestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: Optional — submit without saving new values
      responses:
        "200":
          description: Test submitted; non-empty values locked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderedTestDetail'
        "403":
          description: Sample not collected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          $ref: '#/components/responses/NotFound'
        "401":
          $ref: '#/components/responses/Unauthorized'

  /results/tests/{orderedTestId}:submit-and-verify:
    post:
      operationId: submitAndVerifyTest
      summary: Submit + verify + trigger publish in one command (requires result.verify permission)
      tags: [Results]
      parameters:
        - name: orderedTestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: Optional body; command is idempotent
      responses:
        "200":
          description: Test submitted and verified; document pipeline enqueued
          content:
            application/json:
              schema:
                type: object
                properties:
                  orderedTest:
                    $ref: '#/components/schemas/OrderedTestDetail'
                  documentJobId:
                    type: string
                    nullable: true
        "403":
          description: Insufficient permissions or sample not collected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          $ref: '#/components/responses/NotFound'
        "401":
          $ref: '#/components/responses/Unauthorized'

  # ─── Verification ─────────────────────────────────────────────────

  /verification/encounters/pending:
    get:
      operationId: getVerificationQueue
      summary: List encounters with submitted tests pending verification
      tags: [Verification]
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        "200":
          description: Verification queue
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/VerificationEncounterSummary'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'

  /verification/encounters/{encounterId}:
    get:
      operationId: getVerificationEncounterDetail
      summary: Get encounter with submitted tests for verification (only filled parameters)
      tags: [Verification]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Encounter verification detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  encounter:
                    $ref: '#/components/schemas/Encounter'
                  patient:
                    $ref: '#/components/schemas/Patient'
                  submittedTestsCount:
                    type: integer
                  pendingVerificationCount:
                    type: integer
                  testCards:
                    type: array
                    items:
                      $ref: '#/components/schemas/VerificationTestCard'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'

  /verification/encounters/{encounterId}:verify:
    post:
      operationId: verifyEncounter
      summary: Verify all submitted tests for an encounter and trigger publish
      tags: [Verification]
      parameters:
        - name: encounterId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: No body required
      responses:
        "200":
          description: Encounter verified; document pipeline enqueued
          content:
            application/json:
              schema:
                type: object
                properties:
                  encounterId:
                    type: string
                  status:
                    type: string
                  documentJobId:
                    type: string
                    nullable: true
        "409":
          description: No submitted tests to verify
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
